<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OwnAFarm - Farmer Registration Test</title>
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --secondary: #1e293b;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --success: #22c55e;
            --error: #ef4444;
            --warning: #f59e0b;
            --border: #334155;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a2332 100%);
            min-height: 100vh;
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
        }

        .container {
            max-width: 800px;
            width: 100%;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, #34d399 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-badge {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .btn {
            width: 100%;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px -10px rgba(16, 185, 129, 0.5);
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: #2d3b50;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        label .required {
            color: var(--error);
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: #0d1117;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary);
            margin: 24px 0 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .section-title:first-of-type {
            margin-top: 0;
        }

        .info-box {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .info-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .info-value {
            font-family: 'SF Mono', 'Consolas', monospace;
            font-size: 0.9rem;
            word-break: break-all;
            color: var(--primary);
        }

        .status {
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 0.9rem;
            display: none;
        }

        .status.show {
            display: block;
        }

        .status.success {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: var(--success);
        }

        .status.error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--error);
        }

        .status.loading {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--warning);
        }

        .response-box {
            background: #0d1117;
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            font-family: 'SF Mono', 'Consolas', monospace;
            font-size: 0.8rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            display: none;
        }

        .response-box.show {
            display: block;
        }

        .api-info {
            background: rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 0.85rem;
        }

        .api-method {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.75rem;
            margin-right: 8px;
        }

        .api-method.post {
            background: #3b82f6;
        }

        .api-endpoint {
            font-family: 'SF Mono', 'Consolas', monospace;
            color: var(--text-secondary);
        }

        .file-input-wrapper {
            position: relative;
        }

        .file-input-wrapper input[type="file"] {
            display: none;
        }

        .file-input-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 16px;
            background: #0d1117;
            border: 2px dashed var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-input-btn:hover {
            border-color: var(--primary);
        }

        .file-input-btn.has-file {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }

        .file-name {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        footer {
            margin-top: 40px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        footer a {
            color: var(--primary);
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        .divider {
            height: 1px;
            background: var(--border);
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo">üåæ OwnAFarm</div>
            <p class="subtitle">Farmer Registration Test Page</p>
        </header>

        <!-- Step 1: Get Presigned URLs -->
        <div class="card" id="step1">
            <div class="card-title">
                <span class="step-badge">Step 1</span>
                Upload Documents
            </div>
            <div class="api-info">
                <span class="api-method post">POST</span>
                <span class="api-endpoint">/farmers/documents/presign</span>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                Select your documents (KTP and Selfie with KTP). We'll get presigned URLs and upload them.
            </p>

            <div class="form-row">
                <div class="form-group">
                    <label>KTP Photo <span class="required">*</span></label>
                    <div class="file-input-wrapper">
                        <input type="file" id="ktpFile" accept="image/*"
                            onchange="updateFileName('ktpFile', 'ktpFileName')">
                        <div class="file-input-btn" onclick="document.getElementById('ktpFile').click()">
                            üìÑ Choose KTP Photo
                        </div>
                        <div class="file-name" id="ktpFileName">No file selected</div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Selfie with KTP <span class="required">*</span></label>
                    <div class="file-input-wrapper">
                        <input type="file" id="selfieFile" accept="image/*"
                            onchange="updateFileName('selfieFile', 'selfieFileName')">
                        <div class="file-input-btn" onclick="document.getElementById('selfieFile').click()">
                            ü§≥ Choose Selfie Photo
                        </div>
                        <div class="file-name" id="selfieFileName">No file selected</div>
                    </div>
                </div>
            </div>

            <button class="btn btn-secondary" id="uploadBtn" onclick="uploadDocuments()">
                üì§ Upload Documents
            </button>
            <div class="status" id="uploadStatus"></div>
            <div class="response-box" id="uploadResponse"></div>
        </div>

        <!-- Step 2: Fill Registration Form -->
        <div class="card" id="step2">
            <div class="card-title">
                <span class="step-badge">Step 2</span>
                Fill Registration Form
            </div>
            <div class="api-info">
                <span class="api-method post">POST</span>
                <span class="api-endpoint">/farmers/register</span>
            </div>

            <form id="registrationForm">
                <!-- Personal Info -->
                <div class="section-title">üìã Personal Information</div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Full Name <span class="required">*</span></label>
                        <input type="text" id="fullName" value="Budi Santoso Test" required>
                    </div>
                    <div class="form-group">
                        <label>Email <span class="required">*</span></label>
                        <input type="email" id="email" value="budi.test@example.com" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Phone Number <span class="required">*</span></label>
                        <input type="tel" id="phoneNumber" value="+6281234567890" required>
                    </div>
                    <div class="form-group">
                        <label>ID Number (NIK) <span class="required">*</span></label>
                        <input type="text" id="idNumber" value="3201234567890123" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Date of Birth <span class="required">*</span></label>
                        <input type="date" id="dateOfBirth" value="1985-06-15" required>
                    </div>
                    <div class="form-group">
                        <label>Postal Code <span class="required">*</span></label>
                        <input type="text" id="postalCode" value="40132" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Address <span class="required">*</span></label>
                    <textarea id="address" required>Jl. Merdeka No. 123</textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Province <span class="required">*</span></label>
                        <input type="text" id="province" value="Jawa Barat" required>
                    </div>
                    <div class="form-group">
                        <label>City <span class="required">*</span></label>
                        <input type="text" id="city" value="Bandung" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>District <span class="required">*</span></label>
                    <input type="text" id="district" value="Coblong" required>
                </div>

                <!-- Business Info -->
                <div class="section-title">üè¢ Business Information</div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Business Name</label>
                        <input type="text" id="businessName" value="Tani Makmur Test">
                    </div>
                    <div class="form-group">
                        <label>Business Type <span class="required">*</span></label>
                        <select id="businessType" required>
                            <option value="individual">Individual</option>
                            <option value="cv" selected>CV</option>
                            <option value="pt">PT</option>
                            <option value="ud">UD</option>
                            <option value="cooperative">Cooperative</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>NPWP</label>
                        <input type="text" id="npwp" value="12.345.678.9-123.000">
                    </div>
                    <div class="form-group">
                        <label>Years of Experience</label>
                        <input type="number" id="yearsOfExperience" value="10" min="0">
                    </div>
                </div>

                <div class="section-title">üè¶ Bank Information</div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Bank Name <span class="required">*</span></label>
                        <input type="text" id="bankName" value="Bank BCA" required>
                    </div>
                    <div class="form-group">
                        <label>Account Number <span class="required">*</span></label>
                        <input type="text" id="bankAccountNumber" value="1234567890" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Account Holder Name <span class="required">*</span></label>
                    <input type="text" id="bankAccountName" value="Budi Santoso Test" required>
                </div>

                <div class="section-title">üå± Crops Expertise</div>

                <div class="form-group">
                    <label>Crops (comma separated)</label>
                    <input type="text" id="cropsExpertise" value="padi, jagung, cabai">
                </div>
            </form>

            <button class="btn btn-primary" id="registerBtn" onclick="registerFarmer()">
                üöÄ Register Farmer
            </button>
            <div class="status" id="registerStatus"></div>
            <div class="response-box" id="registerResponse"></div>
        </div>

        <!-- Result -->
        <div class="card" id="resultCard" style="display: none;">
            <div class="card-title">
                ‚úÖ Registration Successful
            </div>
            <div class="info-box">
                <div class="info-label">Farmer ID:</div>
                <div class="info-value" id="farmerId"></div>
            </div>
            <div class="info-box" style="background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3);">
                <div class="info-label">Status:</div>
                <div class="info-value" id="farmerStatus" style="color: #f59e0b;"></div>
            </div>
            <p style="color: var(--text-secondary); margin-top: 16px;">
                ‚è≥ Your registration is now pending admin approval. Admin needs to approve via
                <code>PATCH /admin/farmers/:id/approve</code>
            </p>
        </div>

        <footer>
            <p>API Base URL: <a href="https://ownafarm-backend-production.up.railway.app"
                    target="_blank">https://ownafarm-backend-production.up.railway.app</a></p>
            <p style="margin-top: 8px;">Made for OwnAFarm Backend Testing</p>
        </footer>
    </div>

    <script>
        const API_BASE = 'https://ownafarm-backend-production.up.railway.app';

        let uploadedDocuments = [];

        // Helper functions
        function showStatus(elementId, type, message) {
            const el = document.getElementById(elementId);
            el.className = `status show ${type}`;
            el.textContent = message;
        }

        function hideStatus(elementId) {
            document.getElementById(elementId).className = 'status';
        }

        function showResponse(elementId, data) {
            const el = document.getElementById(elementId);
            el.textContent = JSON.stringify(data, null, 2);
            el.className = 'response-box show';
        }

        function updateFileName(inputId, labelId) {
            const input = document.getElementById(inputId);
            const label = document.getElementById(labelId);
            const wrapper = input.parentElement.querySelector('.file-input-btn');

            if (input.files.length > 0) {
                label.textContent = input.files[0].name;
                wrapper.classList.add('has-file');
            } else {
                label.textContent = 'No file selected';
                wrapper.classList.remove('has-file');
            }
        }

        // Helper: Upload file using XMLHttpRequest (better CORS handling for some cases)
        function uploadFileXHR(url, file) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('PUT', url, true);

                xhr.onload = function () {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        resolve(xhr);
                    } else {
                        reject(new Error(`Upload failed with status ${xhr.status}`));
                    }
                };

                xhr.onerror = function () {
                    reject(new Error('Network error during upload'));
                };

                xhr.send(file);
            });
        }

        // Step 1: Upload Documents
        async function uploadDocuments() {
            const btn = document.getElementById('uploadBtn');
            const ktpFile = document.getElementById('ktpFile').files[0];
            const selfieFile = document.getElementById('selfieFile').files[0];

            if (!ktpFile || !selfieFile) {
                showStatus('uploadStatus', 'error', '‚ùå Please select both KTP and Selfie photos');
                return;
            }

            try {
                btn.disabled = true;
                showStatus('uploadStatus', 'loading', '‚è≥ Getting presigned URLs...');

                // Get presigned URLs
                const presignResponse = await fetch(`${API_BASE}/farmers/documents/presign`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        document_types: ['ktp_photo', 'selfie_with_ktp']
                    })
                });

                const presignData = await presignResponse.json();

                if (presignData.status !== 'success') {
                    throw new Error(presignData.message || 'Failed to get presigned URLs');
                }

                showResponse('uploadResponse', presignData);

                const ktpUrl = presignData.data.urls.find(u => u.document_type === 'ktp_photo');
                const selfieUrl = presignData.data.urls.find(u => u.document_type === 'selfie_with_ktp');

                // Upload files using XHR
                showStatus('uploadStatus', 'loading', '‚è≥ Uploading KTP photo...');
                await uploadFileXHR(ktpUrl.upload_url, ktpFile);

                showStatus('uploadStatus', 'loading', '‚è≥ Uploading Selfie photo...');
                await uploadFileXHR(selfieUrl.upload_url, selfieFile);

                // Save document info for registration
                uploadedDocuments = [
                    {
                        document_type: 'ktp_photo',
                        file_key: ktpUrl.file_key,
                        file_name: ktpFile.name,
                        file_size: ktpFile.size,
                        mime_type: ktpFile.type
                    },
                    {
                        document_type: 'selfie_with_ktp',
                        file_key: selfieUrl.file_key,
                        file_name: selfieFile.name,
                        file_size: selfieFile.size,
                        mime_type: selfieFile.type
                    }
                ];

                showStatus('uploadStatus', 'success', '‚úÖ Documents uploaded successfully! Now fill the form and register.');
                btn.textContent = '‚úÖ Documents Uploaded';

            } catch (error) {
                showStatus('uploadStatus', 'error', `‚ùå Upload failed: ${error.message}. You can still register with dummy files by clicking "Register Farmer".`);
                btn.disabled = false;
            }
        }

        // Step 2: Register Farmer
        async function registerFarmer() {
            const btn = document.getElementById('registerBtn');

            // Use uploaded documents or create dummy ones for testing
            const documents = uploadedDocuments.length > 0 ? uploadedDocuments : [
                {
                    document_type: 'ktp_photo',
                    file_key: 'farmers/documents/test-ktp.jpg',
                    file_name: 'ktp-test.jpg',
                    file_size: 245678,
                    mime_type: 'image/jpeg'
                },
                {
                    document_type: 'selfie_with_ktp',
                    file_key: 'farmers/documents/test-selfie.jpg',
                    file_name: 'selfie-test.jpg',
                    file_size: 189234,
                    mime_type: 'image/jpeg'
                }
            ];

            // Parse crops expertise
            const cropsInput = document.getElementById('cropsExpertise').value;
            const cropsExpertise = cropsInput.split(',').map(c => c.trim()).filter(c => c);

            const payload = {
                personal_info: {
                    full_name: document.getElementById('fullName').value,
                    email: document.getElementById('email').value,
                    phone_number: document.getElementById('phoneNumber').value,
                    id_number: document.getElementById('idNumber').value,
                    date_of_birth: document.getElementById('dateOfBirth').value,
                    address: document.getElementById('address').value,
                    province: document.getElementById('province').value,
                    city: document.getElementById('city').value,
                    district: document.getElementById('district').value,
                    postal_code: document.getElementById('postalCode').value
                },
                business_info: {
                    business_name: document.getElementById('businessName').value,
                    business_type: document.getElementById('businessType').value,
                    npwp: document.getElementById('npwp').value,
                    bank_name: document.getElementById('bankName').value,
                    bank_account_number: document.getElementById('bankAccountNumber').value,
                    bank_account_name: document.getElementById('bankAccountName').value,
                    years_of_experience: parseInt(document.getElementById('yearsOfExperience').value) || 0,
                    crops_expertise: cropsExpertise
                },
                documents: documents
            };

            try {
                btn.disabled = true;
                showStatus('registerStatus', 'loading', '‚è≥ Registering farmer...');

                const response = await fetch(`${API_BASE}/farmers/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                showResponse('registerResponse', data);

                if (data.status === 'success') {
                    showStatus('registerStatus', 'success', '‚úÖ Registration successful!');

                    // Show result card
                    document.getElementById('resultCard').style.display = 'block';
                    document.getElementById('farmerId').textContent = data.data.farmer_id;
                    document.getElementById('farmerStatus').textContent = data.data.status.toUpperCase();

                    // Scroll to result
                    document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth' });

                } else {
                    showStatus('registerStatus', 'error', `‚ùå Registration failed: ${data.message}`);
                    btn.disabled = false;
                }

            } catch (error) {
                showStatus('registerStatus', 'error', `‚ùå Request failed: ${error.message}`);
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>